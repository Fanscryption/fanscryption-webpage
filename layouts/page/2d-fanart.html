<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>2D Fanart</title>

    {{ $style := resources.Get "css/style.css" | resources.Minify | resources.Fingerprint }}
    <link rel="stylesheet" href="{{ $style.Permalink }}">

    {{ $masonryjs := resources.Get "js/masonry.pkgd.min.js" | resources.Fingerprint }}
    <script src="{{ $masonryjs.Permalink }}"></script>

    <style>
      body {
        background: url('/resources/index/leather.jpg');
      }

      main, header {
        max-width: 800px;
        margin: auto;
      }

      nav > ul {
        display: flex;
        gap: 1em;
        list-style: none;
        padding: 1em 0;
        margin: 0;
      }

      nav > ul a {
        color: inherit;
      }

      h1 {
        text-align: center;
        font-size: 3em;
      }

      img {
        width: 100%;
        user-select: none;
        height: auto;
      }

      article {
        position: relative;
        overflow: hidden;
        border-radius: 8px;
        outline: 1px solid #fc83;
      }

      article::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 0;
        transition: 0.2s;
      }

      article:hover::after {
        background: rgba(0, 0, 0, 0.5);
      }

      article > div {
        position: absolute;
        display: flex;
        flex-direction: column;
        justify-content: end;
        align-items: center;
        margin: 0;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        z-index: 1;
        opacity: 0;
        text-align: center;
        user-select: none;
        transition: 0.2s;
        color: white;
        padding-block: 0;
        padding-inline: 8px;
      }

      article:hover > div {
        opacity: 1;
        user-select: unset;
        padding-bottom: 12px;
      }

      article h2 {
        line-height: 1;
        margin: 0;
        text-wrap: pretty;
        flex-grow: 1;
        display: flex;
        align-items: center;
        padding-top: 1em;
        font-family: Times, sans-serif;
      }

      article a {
        font-family: Marksman, monospace;
        font-size: 1.1em;
        color: wheat;
      }

      article h2, article a {
        text-shadow: 0 0.2em 1em black;
      }

      #fanarts > article {
        width: 256px;
        margin-block-end: 16px;
      }

      @media screen and (max-width: 1000px) {
        nav > ul {
          padding-inline: 1em;
          line-height: 1;
          flex-wrap: wrap;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/3d-physical">Physical / 3D</a></li>
          <li><a href="/creators">Community Contributors</a></li>
          <li><a href="#">Custom Cards</a></li>
        </ul>
      </nav>
    </header>

    <header>
      <h1>{{ .Title }}</h1>
      {{/*<p>{{ .Content }}</p>*/}}
    </header>
    <main>
      {{ $data := dict }}
      {{ with resources.Get "data/responses.json" | transform.Unmarshal }}
        {{ $data = . }}
      {{ else }}
        {{ errorf "2d fanart: could not load responses" }}
      {{ end }}

      {{ $metadata := dict }}
      {{ with resources.Get "data/images-metadata.json" | transform.Unmarshal }}
        {{ $metadata = . }}
      {{ else }}
        {{ errorf "2d fanart: could not load metadata" }}
      {{ end }}

      {{ $projects := where $data "type" "2D Inscryption Fanart" }}
      {{ $fanarts := slice }}

      {{ range $index, $submission := $projects }}
        {{/* get image width */}}
        {{ $imageMetadata := index $metadata $submission.primaryImageURL }}
        {{ $width := $imageMetadata.imageMediaMetadata.width }}
        {{ $height := $imageMetadata.imageMediaMetadata.height }}
        {{/* get image extension */}}
        {{ $extension := lower $imageMetadata.mimeType | replaceRE "image/" "" | replaceRE "jpeg" "jpg" }}

        {{/* add to fanarts */}}
        {{ $fanarts = $fanarts | append (
            dict
                "id" $submission.primaryImageURL
                "extension" $extension
                "width" $width
                "height" $height
                "title" $submission.title
                "socials" $submission.socials
                "discordUsername" $submission.discordUsername
            )
        }}

        {{ range $index, $subimage := $submission.additionalImageURLs }}
          {{ $imageMetadata := index $metadata $subimage }}
          {{ $width := $imageMetadata.imageMediaMetadata.width }}
          {{ $height := $imageMetadata.imageMediaMetadata.height }}
          {{ $extension := lower $imageMetadata.mimeType | replaceRE "image/" "" | replaceRE "jpeg" "jpg" }}

          {{ $fanarts = $fanarts | append (
              dict
                  "id" $subimage
                  "extension" $extension
                  "width" $width
                  "height" $height
                  "title" $submission.title
                  "socials" $submission.socials
                  "discordUsername" $submission.discordUsername
              )
          }}
        {{ end }}
      {{ end }}

      <section id=fanarts style="margin: 0 auto;" data-masonry='{ "itemSelector": "#fanarts > article", "gutter": 16, "fitWidth": true }'>
        {{ range $index, $artwork := $fanarts }}
          <article>
            <img src="/art/{{ $artwork.id }}.{{ $artwork.extension }}" alt="" width='{{ $artwork.width }}' height='{{ $artwork.height }}' />
            <div>
              <h2>{{ $artwork.title }}</h2>
              <a {{ if $artwork.socials }}href='{{ $artwork.socials }}'{{ end }}>{{ $artwork.discordUsername }}</a>
            </div>
          </article>
        {{ end }}
      </section>

      <style>

        dialog {
          --total-height: 95svh;
          --info-height: 100px;

          max-width: min(1000px, 95vw);
          padding-block-end: 0;
          border: 1px solid #fff7;
          background: #332929;
          background: url('/resources/index/leather.jpg');
        }

        dialog img {
          max-height: calc(var(--total-height) - 5svh - var(--info-height));
        }

        dialog > .info {
          display: flex;
          justify-content: space-between;
          align-items: center;
          height: var(--info-height);
        }

        dialog > .info .title {
          display: block;
          font-size: 1.2em;
        }

        dialog > .info > form {
        }

        dialog > .info > form > button {

        }

        dialog::backdrop {
          opacity: 0.5;
          background-color: #000;
        }

        body:has(dialog[open]) {
          /* vladde: this is the ugliest hack i've seen this year */
          filter: blur(4px);
        }
      </style>

      <dialog>
        <img alt='' class=image>

        <div class=info>
          <div class=credits>
            <span class=title></span>
            <a class=author></a>
          </div>

          <form method="dialog">
            <button>Close</button>
          </form>
        </div>
      </dialog>

      <script>
        const dialog = document.querySelector("dialog");
        const closeButton = document.querySelector("dialog button");

        closeButton.addEventListener("click", () => {
          dialog.close();
        });

        const fanarts = document.querySelectorAll("#fanarts > article");
        for (const fanart of fanarts) {
          fanart.addEventListener("click", () => {
            const sourceImage = fanart.querySelector("img");
            const sourceTitle = fanart.querySelector("h2");
            const sourceAuthor = fanart.querySelector("a");

            const image = dialog.querySelector(".image");
            image.src = sourceImage.src;
            image.width = sourceImage.getAttribute("width") ?? 0;
            image.height = sourceImage.getAttribute("height") ?? 0;

            const title = dialog.querySelector(".title");
            title.textContent = sourceTitle.textContent;

            const author = dialog.querySelector(".author");
            author.textContent = sourceAuthor.textContent;

            const href = sourceAuthor.getAttribute("href");
            if (href) {
              author.href = href
            }

            setTimeout(() => {
              // vladde: hack to make not overlay image flicker on popup
              dialog.showModal();
            }, 0);
          });
        }

      </script>
    </main>
  </body>
</html>